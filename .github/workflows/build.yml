name: macOS DMG Build and Release

on:
  push:
    branches:
      - master # –ó–∞–ø—É—Å–∫–∞—Ç—å —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É master

permissions:
  contents: write # –†–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–∞

jobs:
  build-macos:
    name: üéâ –°–±–æ—Ä–∫–∞ macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Å–æ–∑–¥–∞–Ω–∏–µ DMG
    runs-on: macos-latest # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é macOS —Ä–∞–Ω–µ—Ä–∞

    steps:
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
        uses: actions/checkout@v4 # –ò–∑–≤–ª–µ—á—å –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter SDK
        uses: subosito/flutter-action@v2 # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é –¥–µ–π—Å—Ç–≤–∏—è Flutter
        with:
          channel: stable # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª Flutter
          architecture: x64 # <-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Å x66 –Ω–∞ x64
          
      - name: üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Flutter
        run: flutter pub get # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞

      - name: üî® –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è macOS (—Ä–µ–ª–∏–∑–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        run: flutter build macos --release # –°–æ–±—Ä–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Flutter –¥–ª—è macOS –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–ª–∏–∑–∞

      - name: üóÇ –ü–æ–∏—Å–∫ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        id: find_app # –ü—Ä–∏—Å–≤–æ–∏—Ç—å ID —ç—Ç–æ–º—É —à–∞–≥—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –µ–≥–æ –≤—ã–≤–æ–¥–∞–º
        run: |
          # –°–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±—ã—á–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ build/macos/Build/Products/Release/
          # –ù–∞–º –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –µ–≥–æ —Ç–æ—á–Ω–æ–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'Runner.app' –∏–ª–∏ 'YourAppName.app')
          APP_DIR="build/macos/Build/Products/Release/"
          # –ù–∞–π—Ç–∏ –ø–µ—Ä–≤—ã–π –∫–∞—Ç–∞–ª–æ–≥, –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–π—Å—è –Ω–∞ ".app"
          APP_NAME=$(find "$APP_DIR" -maxdepth 1 -type d -name "*.app" | head -n 1)
          
          if [ -z "$APP_NAME" ]; then
            echo "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–∞–∫–µ—Ç .app –≤ $APP_DIR"
            exit 1
          fi
          
          # –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤–æ–µ –∏–º—è –ø–∞–∫–µ—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Runner.app")
          APP_BASENAME=$(basename "$APP_NAME")
          
          echo "–ù–∞–π–¥–µ–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: $APP_BASENAME"
          # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–≤–æ–¥—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–∞—Ö
          echo "app_path=$APP_NAME" >> "$GITHUB_OUTPUT"
          echo "app_basename=$APP_BASENAME" >> "$GITHUB_OUTPUT"

      - name: ‚¨áÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ appdmg CLI
        run: npm install --global appdmg # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É—Ç–∏–ª–∏—Ç—É appdmg –≥–ª–æ–±–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ npm

      - name: üíæ –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ DMG —Å –ø–æ–º–æ—â—å—é appdmg
        run: |
          # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ–º JSON-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è appdmg
          # –ü—É—Ç—å –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º –∫ —Ç–µ–∫—É—â–µ–π —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          # (–∫–æ—Ç–æ—Ä–∞—è —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è)
          APP_PATH_RELATIVE_TO_WORKSPACE="${{ steps.find_app.outputs.app_path }}"
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π JSON-—Ñ–∞–π–ª –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ appdmg
          cat <<EOF > appdmg.json
          {
            "title": "My Flutter App",
            "contents": [
              { "x": 200, "y": 190, "type": "file", "path": "$APP_PATH_RELATIVE_TO_WORKSPACE" },
              { "x": 600, "y": 185, "type": "link", "path": "/Applications" }
            ],
            "format": "ULFO"
          }
          EOF
          
          # –í—ã–∑—ã–≤–∞–µ–º appdmg, –ø–µ—Ä–µ–¥–∞–≤–∞—è –ø—É—Ç—å –∫ JSON-—Ñ–∞–π–ª—É –∏ –ø—É—Ç—å –∫ –≤—ã—Ö–æ–¥–Ω–æ–º—É DMG
          # –û–ø—Ü–∏—è --no-internet-enable –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ø—ã—Ç–∫–∏ appdmg –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏
          appdmg appdmg.json MyFlutterApp.dmg --no-internet-enable
          
          # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ñ–∞–π–ª DMG —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ ! -f MyFlutterApp.dmg ]; then
            echo "–û—à–∏–±–∫–∞: –§–∞–π–ª MyFlutterApp.dmg –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω."
            exit 1
          fi

      - name: üåê –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ GitHub Release
        uses: svenstaro/upload-release-action@v2 # –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ —Ä–µ–ª–∏–∑ GitHub
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }} # –¢–æ–∫–µ–Ω –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ GitHub
          file: MyFlutterApp.dmg # –§–∞–π–ª DMG, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —à–∞–≥–µ
          tag: latest-mac-release # –¢–µ–≥ —Ä–µ–ª–∏–∑–∞. –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –µ–≥–æ –Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π, –Ω–∞–ø—Ä–∏–º–µ—Ä, v1.0.0
          overwrite: true # –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–∫—Ç–∏–≤, –µ—Å–ª–∏ —Ç–µ–≥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          body: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±—Ä–∞–Ω–Ω–æ–µ macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (DMG). # –û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞
          draft: false # –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Ä–µ–ª–∏–∑ —Å—Ä–∞–∑—É (true –¥–ª—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞)
          prerelease: false # –ù–µ –ø–æ–º–µ—á–∞—Ç—å –∫–∞–∫ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–ª–∏–∑
