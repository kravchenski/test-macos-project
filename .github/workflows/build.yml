name: macOS DMG Build and Release (Alternative)

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  build-macos:
    name: üéâ Build macOS DMG
    runs-on: macos-latest

    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Install Flutter
        uses: subosito/flutter-action@v3
        with:
          channel: stable
          architecture: x64

      - name: üì¶ Get dependencies
        run: flutter pub get

      - name: üî® Build macOS application (release)
        run: flutter build macos --release

      - name: üóÇ Find the built app
        id: find_app
        run: |
          # The built app is usually in build/macos/Build/Products/Release/
          # We need to find its exact name (e.g., 'Runner.app' or 'YourAppName.app')
          APP_DIR="build/macos/Build/Products/Release/"
          APP_NAME=$(find "$APP_DIR" -maxdepth 1 -type d -name "*.app" | head -n 1)
          if [ -z "$APP_NAME" ]; then
            echo "Error: Could not find .app bundle in $APP_DIR"
            exit 1
          fi
          # Remove the leading path part to get just the app bundle name
          APP_BASENAME=$(basename "$APP_NAME")
          echo "Found application: $APP_BASENAME"
          echo "app_path=$APP_NAME" >> "$GITHUB_OUTPUT"
          echo "app_basename=$APP_BASENAME" >> "$GITHUB_OUTPUT"

      - name: üíæ Create DMG image
        uses: actions/sindresorhus/create-dmg@v3
        with:
          name: MyFlutterApp.dmg # Output DMG filename
          app-path: ${{ steps.find_app.outputs.app_path }} # Path to your .app bundle
          icon-path: macos/Runner/Assets.xcassets/AppIcon.appiconset/icon.icns # Path to your .icns icon
          volume-name: MyFlutterApp
          background: # Optional: path to a background image, e.g., 'assets/dmg-background.png'
          window-pos: '200 120'
          window-size: '800 600'
          icon-size: 100
          icon-x: 200 # X coordinate for the app icon
          icon-y: 190 # Y coordinate for the app icon
          app-drop-link-x: 600 # X coordinate for the Applications drop link
          app-drop-link-y: 185 # Y coordinate for the Applications drop link
          # You can add more options from create-dmg documentation here

      - name: üåê Publish as GitHub Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: MyFlutterApp.dmg # This is the name of the DMG created by the previous step
          tag: latest-mac-release
          overwrite: true
          body: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±—Ä–∞–Ω–Ω–æ–µ macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
          draft: false
          prerelease: false