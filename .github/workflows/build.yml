name: üéâ –°–±–æ—Ä–∫–∞ macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Å–æ–∑–¥–∞–Ω–∏–µ DMG

on:
  push:
    branches:
      - master # –ó–∞–ø—É—Å–∫–∞—Ç—å —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É master

permissions:
  contents: write # –†–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–∞

jobs:
  build-macos:
    name: üéâ –°–±–æ—Ä–∫–∞ macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Å–æ–∑–¥–∞–Ω–∏–µ DMG
    runs-on: macos-latest # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é macOS —Ä–∞–Ω–µ—Ä–∞

    steps:
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
        uses: actions/checkout@v4 # –ò–∑–≤–ª–µ—á—å –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: stable # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª Flutter

      - name: üñ•Ô∏è –í–∫–ª—é—á–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É macOS
        run: flutter config --enable-macos-desktop

      - name: üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Flutter
        run: flutter pub get

      - name: üß™ –í—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞
        run: flutter analyze

      - name: üî® –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è macOS (—Ä–µ–ª–∏–∑–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        run: flutter build macos --release

      - name: üóÇ –ü–æ–∏—Å–∫ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        id: find_app
        run: |
          APP_DIR="build/macos/Build/Products/Release/"
          APP_NAME=$(find "$APP_DIR" -maxdepth 1 -type d -name "*.app" | head -n 1)

          if [ -z "$APP_NAME" ]; then
            echo "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–∞–∫–µ—Ç .app –≤ $APP_DIR"
            exit 1
          fi

          APP_BASENAME=$(basename "$APP_NAME")
          echo "app_path=$APP_NAME" >> "$GITHUB_OUTPUT"
          echo "app_basename=$APP_BASENAME" >> "$GITHUB_OUTPUT"

      - name: ‚¨áÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ appdmg CLI
        run: npm install --global appdmg

      - name: üíæ –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ DMG —Å –ø–æ–º–æ—â—å—é appdmg
        run: |
          APP_PATH_RELATIVE_TO_WORKSPACE="${{ steps.find_app.outputs.app_path }}"
          
          cat <<EOF > appdmg.json
          {
            "title": "My Flutter App",
            "contents": [
              { "x": 200, "y": 190, "type": "file", "path": "$APP_PATH_RELATIVE_TO_WORKSPACE" },
              { "x": 600, "y": 185, "type": "link", "path": "/Applications" }
            ],
            "format": "ULFO"
          }
          EOF

          appdmg appdmg.json MyFlutterApp.dmg --no-internet-enable

          if [ ! -f MyFlutterApp.dmg ]; then
            echo "–û—à–∏–±–∫–∞: –§–∞–π–ª MyFlutterApp.dmg –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω."
            exit 1
          fi

      - name: üåê –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ GitHub Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: MyFlutterApp.dmg
          tag: latest-mac-release
          overwrite: true
          body: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±—Ä–∞–Ω–Ω–æ–µ macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (DMG).
          draft: false
          prerelease: false